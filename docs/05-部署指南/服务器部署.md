# 生产环境部署步骤（Docker+K8s）

## 环境准备

### 基础设施要求
- **Kubernetes 集群**：Kubernetes 1.20+ 版本
- **Docker 镜像仓库**：Docker Hub 或私有镜像仓库
- **负载均衡器**：用于外部访问
- **持久化存储**：支持 Kubernetes PV/PVC
- **监控系统**：Prometheus + Grafana（推荐）

### 工具准备
- `kubectl`：Kubernetes 命令行工具
- `helm`：Kubernetes 包管理工具
- `docker`：容器构建工具
- `git`：代码管理工具

## 镜像构建与发布

### 1. 构建前端镜像
```bash
cd CloudVoiceNovel/frontend

# 构建镜像
docker build -t your-registry/cloudvoicenovel-frontend:latest .

# 推送镜像
docker push your-registry/cloudvoicenovel-frontend:latest
```

### 2. 构建后端镜像
```bash
cd ../backend

# 构建镜像
docker build -t your-registry/cloudvoicenovel-backend:latest .

# 推送镜像
docker push your-registry/cloudvoicenovel-backend:latest
```

## Kubernetes 部署

### 1. 创建命名空间
```bash
kubectl create namespace cloudvoicenovel
```

### 2. 配置 Secret
创建包含敏感信息的 Kubernetes Secret：

```bash
kubectl create secret generic cloudvoicenovel-secrets \
  --namespace=cloudvoicenovel \
  --from-literal=database-url=mongodb://user:password@mongodb:27017/cloudvoicenovel \
  --from-literal=redis-url=redis://redis:6379 \
  --from-literal=secret-key=your_jwt_secret_key \
  --from-literal=api-key=your_api_key
```

### 3. 部署 MongoDB

#### 使用 Helm 部署 MongoDB
```bash
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

helm install mongodb bitnami/mongodb \
  --namespace=cloudvoicenovel \
  --set auth.rootPassword=yourRootPassword \
  --set auth.username=cloudvoice \
  --set auth.password=yourPassword \
  --set auth.database=cloudvoicenovel \
  --set persistence.enabled=true \
  --set persistence.size=10Gi
```

### 4. 部署 Redis

#### 使用 Helm 部署 Redis
```bash
helm install redis bitnami/redis \
  --namespace=cloudvoicenovel \
  --set auth.enabled=true \
  --set auth.password=yourRedisPassword \
  --set persistence.enabled=true \
  --set persistence.size=2Gi
```

### 5. 部署后端服务

创建 `backend-deployment.yaml`：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudvoicenovel-backend
  namespace: cloudvoicenovel
spec:
  replicas: 3
  selector:
    matchLabels:
      app: cloudvoicenovel-backend
  template:
    metadata:
      labels:
        app: cloudvoicenovel-backend
    spec:
      containers:
      - name: backend
        image: your-registry/cloudvoicenovel-backend:latest
        ports:
        - containerPort: 3000
        env:
        - name: PORT
          value: "3000"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: cloudvoicenovel-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: cloudvoicenovel-secrets
              key: redis-url
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: cloudvoicenovel-secrets
              key: secret-key
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: cloudvoicenovel-secrets
              key: api-key
        - name: NODE_ENV
          value: "production"
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 60
          periodSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: cloudvoicenovel-backend
  namespace: cloudvoicenovel
spec:
  selector:
    app: cloudvoicenovel-backend
  ports:
  - port: 3000
    targetPort: 3000
  type: ClusterIP
```

应用部署：
```bash
kubectl apply -f backend-deployment.yaml
```

### 6. 部署前端服务

创建 `frontend-deployment.yaml`：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudvoicenovel-frontend
  namespace: cloudvoicenovel
spec:
  replicas: 3
  selector:
    matchLabels:
      app: cloudvoicenovel-frontend
  template:
    metadata:
      labels:
        app: cloudvoicenovel-frontend
    spec:
      containers:
      - name: frontend
        image: your-registry/cloudvoicenovel-frontend:latest
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "300m"
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 20
          periodSeconds: 15
---
apiVersion: v1
kind: Service
metadata:
  name: cloudvoicenovel-frontend
  namespace: cloudvoicenovel
spec:
  selector:
    app: cloudvoicenovel-frontend
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
```

应用部署：
```bash
kubectl apply -f frontend-deployment.yaml
```

### 7. 配置 Ingress

创建 `ingress.yaml`：

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cloudvoicenovel-ingress
  namespace: cloudvoicenovel
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - app.cloudvoicenovel.com
    secretName: cloudvoicenovel-tls
  rules:
  - host: app.cloudvoicenovel.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: cloudvoicenovel-frontend
            port:
              number: 80
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: cloudvoicenovel-backend
            port:
              number: 3000
```

应用配置：
```bash
kubectl apply -f ingress.yaml
```

## 数据库初始化

### 执行数据库迁移
```bash
kubectl run -it --rm --restart=Never migration \
  --image=your-registry/cloudvoicenovel-backend:latest \
  --namespace=cloudvoicenovel \
  --env="DATABASE_URL=$(kubectl get secret cloudvoicenovel-secrets -n cloudvoicenovel -o jsonpath='{.data.database-url}' | base64 --decode)" \
  -- npm run migrate
```

## 监控与日志

### 配置 Prometheus 监控

创建 `monitoring.yaml`：

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: cloudvoicenovel-monitor
  namespace: cloudvoicenovel
  labels:
    release: prometheus
spec:
  selector:
    matchLabels:
      app: cloudvoicenovel-backend
  endpoints:
  - port: "3000"
    path: /metrics
```

应用配置：
```bash
kubectl apply -f monitoring.yaml
```

### 配置日志收集

推荐使用 EFK 堆栈（Elasticsearch, Fluentd, Kibana）或 Loki 进行日志收集和分析。

## 伸缩策略

### 配置 HPA（Horizontal Pod Autoscaler）

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: cloudvoicenovel-backend-hpa
  namespace: cloudvoicenovel
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cloudvoicenovel-backend
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

应用配置：
```bash
kubectl apply -f backend-hpa.yaml
```

对前端服务也可以配置类似的 HPA。

## CI/CD 集成

### 使用 GitHub Actions 自动部署

示例 `.github/workflows/deploy.yml`：

```yaml
name: Deploy to Kubernetes

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    # 构建并推送前端镜像
    - name: Build and push frontend
      uses: docker/build-push-action@v2
      with:
        context: ./frontend
        push: true
        tags: your-registry/cloudvoicenovel-frontend:latest
    
    # 构建并推送后端镜像
    - name: Build and push backend
      uses: docker/build-push-action@v2
      with:
        context: ./backend
        push: true
        tags: your-registry/cloudvoicenovel-backend:latest
    
    # 部署到 Kubernetes
    - name: Deploy to Kubernetes
      uses: appleboy/kubectl-action@master
      with:
        kubeconfig: ${{ secrets.KUBECONFIG }}
        namespace: cloudvoicenovel
        args: set image deployment/cloudvoicenovel-frontend frontend=your-registry/cloudvoicenovel-frontend:latest
    
    - name: Deploy backend
      uses: appleboy/kubectl-action@master
      with:
        kubeconfig: ${{ secrets.KUBECONFIG }}
        namespace: cloudvoicenovel
        args: set image deployment/cloudvoicenovel-backend backend=your-registry/cloudvoicenovel-backend:latest
```

## 安全配置

### 网络策略

创建 `network-policy.yaml`：

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cloudvoicenovel-network-policy
  namespace: cloudvoicenovel
spec:
  podSelector:
    matchLabels:
      app: cloudvoicenovel-backend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: cloudvoicenovel-frontend
    ports:
    - protocol: TCP
      port: 3000
  egress:
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: mongodb
    ports:
    - protocol: TCP
      port: 27017
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: redis
    ports:
    - protocol: TCP
      port: 6379
```

应用配置：
```bash
kubectl apply -f network-policy.yaml
```

## 备份策略

### 数据库备份

使用 Kubernetes CronJob 定时备份 MongoDB：

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongodb-backup
  namespace: cloudvoicenovel
spec:
  schedule: "0 2 * * *" # 每天凌晨2点执行
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: mongodb-backup
            image: mongo:4.4
            command:
            - sh
            - -c
            - mongodump --host mongodb --username cloudvoice --password $(MONGODB_PASSWORD) --db cloudvoicenovel --out /backup/$(date +%Y%m%d) && tar -czf /backup/backup-$(date +%Y%m%d).tar.gz /backup/$(date +%Y%m%d)
            env:
            - name: MONGODB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cloudvoicenovel-secrets
                  key: mongodb-password
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
          restartPolicy: OnFailure
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: mongodb-backup-pvc
```

## 部署验证

### 检查部署状态
```bash
kubectl get pods -n cloudvoicenovel
kubectl get svc -n cloudvoicenovel
kubectl get ingress -n cloudvoicenovel
```

### 访问应用
- 前端：https://app.cloudvoicenovel.com
- API：https://app.cloudvoicenovel.com/api
- Swagger：https://app.cloudvoicenovel.com/api/docs

## 生产环境最佳实践

1. **资源限制**：为每个容器设置适当的资源请求和限制
2. **健康检查**：配置适当的就绪探针和存活探针
3. **自动伸缩**：根据负载情况自动调整副本数量
4. **监控告警**：设置关键指标的监控和告警
5. **日志管理**：集中收集和分析日志
6. **备份恢复**：定期备份数据，确保可恢复性
7. **安全加固**：定期更新镜像，配置网络策略，限制访问权限
8. **滚动更新**：使用滚动更新策略，确保服务不中断