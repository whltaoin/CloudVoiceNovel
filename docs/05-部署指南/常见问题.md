# 部署/运行中常见问题排查

## 环境配置问题

### 1. Node.js 版本问题

**症状**：安装依赖失败或运行时出现语法错误

**解决方案**：
- 检查 Node.js 版本：`node -v`
- 确保使用 Node.js 16.x 或更高版本
- 使用 nvm 管理多个 Node.js 版本：
  ```bash
  nvm install 16
  nvm use 16
  ```

### 2. 环境变量配置错误

**症状**：无法连接数据库或API服务不可用

**解决方案**：
- 检查 `.env` 文件是否存在并包含正确的配置
- 确保所有必需的环境变量都已设置
- 验证敏感信息（如密码、密钥）是否正确
- 对于 Docker 环境，检查容器是否正确传递了环境变量

## 数据库相关问题

### 1. MongoDB 连接失败

**症状**：应用启动失败，日志显示数据库连接错误

**解决方案**：
- 确认 MongoDB 服务是否正在运行：`systemctl status mongod` 或 `docker ps`
- 验证 MongoDB 连接字符串格式是否正确
- 检查 MongoDB 用户权限是否正确设置
- 查看 MongoDB 日志文件了解详细错误：`/var/log/mongodb/mongod.log`

### 2. MySQL 连接失败

**症状**：无法连接到 MySQL 数据库

**解决方案**：
- 确认 MySQL 服务状态：`systemctl status mysql`
- 验证数据库连接参数：主机、端口、用户名、密码
- 检查防火墙设置，确保 3306 端口可访问
- 确认用户有正确的权限：`SHOW GRANTS FOR 'username'@'host';`

### 3. Redis 连接失败

**症状**：缓存相关功能不可用

**解决方案**：
- 确认 Redis 服务运行状态：`systemctl status redis`
- 验证 Redis 连接字符串
- 检查 Redis 密码是否配置正确
- 测试连接：`redis-cli -h host -p port ping`

## 部署相关问题

### 1. Docker 镜像构建失败

**症状**：构建过程中出现错误或镜像无法运行

**解决方案**：
- 检查 Dockerfile 语法是否正确
- 确认依赖安装命令是否完整
- 检查构建上下文是否包含所有必需文件
- 使用 `--no-cache` 参数重新构建：`docker build --no-cache -t image-name .`

### 2. Kubernetes 部署问题

**症状**：Pod 无法启动或持续重启

**解决方案**：
- 查看 Pod 状态：`kubectl get pods -n namespace`
- 检查 Pod 日志：`kubectl logs pod-name -n namespace`
- 检查 Pod 事件：`kubectl describe pod pod-name -n namespace`
- 验证配置文件中的资源限制是否合理
- 确保镜像名称和标签正确

### 3. Ingress 配置问题

**症状**：无法通过域名访问应用

**解决方案**：
- 确认 Ingress 控制器已安装：`kubectl get pods -n ingress-nginx`
- 检查 Ingress 资源状态：`kubectl get ingress -n namespace`
- 查看 Ingress 控制器日志
- 验证 DNS 记录是否正确配置
- 检查 SSL 证书是否有效

## 性能问题

### 1. 应用响应缓慢

**症状**：页面加载时间长或 API 响应延迟

**解决方案**：
- 检查服务器资源使用情况：`top`, `htop`
- 分析数据库查询性能，添加必要的索引
- 检查 Redis 缓存是否正常工作
- 监控网络流量，确认是否存在带宽瓶颈
- 使用性能分析工具（如 New Relic、Datadog）定位问题

### 2. 数据库性能下降

**症状**：查询时间变长，数据库负载高

**解决方案**：
- 优化慢查询语句
- 为频繁查询的字段添加索引
- 考虑数据库分片或读写分离
- 清理过期数据，维护数据库表
- 监控数据库连接池配置

### 3. 内存泄漏

**症状**：应用内存使用持续增长，最终崩溃

**解决方案**：
- 使用内存分析工具（如 Node.js 的 heapdump）
- 检查是否有未关闭的资源（文件、数据库连接）
- 审查大对象的生命周期管理
- 设置合理的内存限制，避免进程占用过多资源

## 安全问题

### 1. 未授权访问

**症状**：敏感接口可以被未授权用户访问

**解决方案**：
- 检查认证中间件配置
- 验证 JWT Token 验证逻辑
- 确认所有敏感接口都有适当的权限检查
- 实施 CSRF 保护

### 2. 数据泄露

**症状**：敏感数据在日志或响应中暴露

**解决方案**：
- 审查日志记录逻辑，避免记录敏感信息
- 确保 API 响应中不包含敏感数据
- 实施数据加密，特别是密码和个人信息
- 定期进行安全审计和渗透测试

### 3. 依赖包安全漏洞

**症状**：依赖包存在已知安全漏洞

**解决方案**：
- 定期更新依赖包：`npm audit`, `yarn audit`
- 使用安全扫描工具检查依赖项
- 配置依赖自动更新工具（如 Dependabot）
- 为关键服务实施 WAF（Web 应用防火墙）

## 前端相关问题

### 1. API 请求失败

**症状**：前端无法连接到后端 API

**解决方案**：
- 检查前端配置中的 API 地址是否正确
- 确认 CORS 配置是否允许跨域请求
- 验证网络连接和防火墙设置
- 检查认证令牌是否正确传递

### 2. 静态资源加载失败

**症状**：图片、CSS 或 JavaScript 文件无法加载

**解决方案**：
- 检查资源路径是否正确
- 确认静态文件服务器配置
- 验证文件权限是否正确
- 检查 CDN 配置（如果使用）

### 3. 移动端兼容性问题

**症状**：在某些移动设备上功能不正常

**解决方案**：
- 确认 React Native 版本兼容性
- 测试不同设备和操作系统版本
- 检查原生模块集成是否正确
- 审查响应式设计实现

## 日志与监控

### 1. 日志收集问题

**症状**：无法查看或收集应用日志

**解决方案**：
- 检查日志配置文件是否正确
- 确认日志目录权限设置
- 验证日志轮转配置
- 对于容器环境，使用 `kubectl logs` 或日志聚合系统

### 2. 监控告警设置

**症状**：系统异常未及时通知

**解决方案**：
- 配置关键指标的告警阈值（CPU、内存、响应时间）
- 设置适当的告警渠道（邮件、短信、Slack）
- 实施多级告警机制，避免告警风暴
- 定期测试告警系统的有效性

## 其他常见问题

### 1. 文件上传失败

**症状**：用户无法上传图片或其他文件

**解决方案**：
- 检查文件大小限制配置
- 确认上传目录权限
- 验证文件类型限制设置
- 检查存储空间是否充足

### 2. 音频播放问题

**症状**：音频无法正常播放

**解决方案**：
- 检查音频文件格式是否支持
- 确认音频 URL 是否可访问
- 验证音频服务器配置
- 测试不同浏览器/设备的兼容性

### 3. 定时任务不执行

**症状**：定时任务（如备份、数据同步）未按计划执行

**解决方案**：
- 检查定时任务配置（cron 表达式）
- 验证任务执行权限
- 查看任务日志，分析失败原因
- 确保服务器时区设置正确

## 紧急处理流程

### 服务中断应急响应

1. **确认问题范围**：确定受影响的服务和用户范围
2. **初步诊断**：检查关键组件状态、日志和错误信息
3. **实施回滚**：如为最近部署导致，考虑回滚到上一个稳定版本
4. **恢复服务**：根据问题类型采取相应的恢复措施
5. **事后分析**：记录事件，分析根本原因，制定预防措施

### 数据丢失应急响应

1. **停止写入操作**：防止进一步数据损坏
2. **评估损失范围**：确定丢失的数据类型和时间段
3. **从备份恢复**：使用最近的有效备份进行数据恢复
4. **数据验证**：确认恢复数据的完整性和一致性
5. **更新备份策略**：基于事件改进备份流程和频率

## 联系支持

如果遇到无法解决的问题，请联系技术支持团队：

- **邮箱**：support@cloudvoicenovel.com
- **工作时间**：周一至周五 9:00-18:00
- **紧急联系**：[电话号码]（仅限生产环境严重问题）