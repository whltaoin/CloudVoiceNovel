# 开发环境部署步骤

## 环境要求

### 硬件要求
- CPU: 2核或更高
- 内存: 4GB或更高
- 存储空间: 至少50GB可用空间

### 软件要求
- Node.js 16.x 或更高版本
- npm 或 yarn
- Git
- MongoDB 4.4+ 或 MySQL 8.0+
- Redis 6.0+
- 可选：Docker 和 Docker Compose（推荐用于快速部署）

## 前端部署

### 1. 克隆代码
```bash
git clone [仓库地址]
cd CloudVoiceNovel/frontend
```

### 2. 安装依赖
```bash
npm install
# 或
yarn install
```

### 3. 配置环境变量
```bash
# 复制环境变量示例文件
cp .env.example .env

# 编辑 .env 文件，配置相应的环境变量
# 主要配置项：
# API_BASE_URL=http://localhost:3000/api
# WEBSOCKET_URL=ws://localhost:3000
# STORAGE_TYPE=local
```

### 4. 开发模式启动
```bash
npm run dev
# 或
yarn dev
```

### 5. 构建生产版本（可选）
```bash
npm run build
# 或
yarn build
```

## 后端部署

### 1. 克隆代码（如果尚未克隆）
```bash
git clone [仓库地址]
cd CloudVoiceNovel/backend
```

### 2. 安装依赖
```bash
npm install
# 或
yarn install
```

### 3. 配置数据库

#### MongoDB 配置
- 确保 MongoDB 服务已启动
- 创建数据库：`use cloudvoicenovel`

#### MySQL 配置（如果使用 MySQL）
- 确保 MySQL 服务已启动
- 创建数据库：
  ```sql
  CREATE DATABASE cloudvoicenovel CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
  ```
- 创建用户并授权：
  ```sql
  CREATE USER 'cloudvoice'@'localhost' IDENTIFIED BY 'password';
  GRANT ALL PRIVILEGES ON cloudvoicenovel.* TO 'cloudvoice'@'localhost';
  FLUSH PRIVILEGES;
  ```

#### Redis 配置
- 确保 Redis 服务已启动
- 默认使用 localhost:6379，无需额外配置

### 4. 配置环境变量
```bash
# 复制环境变量示例文件
cp .env.example .env

# 编辑 .env 文件，配置相应的环境变量
# 主要配置项：
# PORT=3000
# DATABASE_URL=mongodb://localhost:27017/cloudvoicenovel
# 或 MySQL 连接字符串
# REDIS_URL=redis://localhost:6379
# SECRET_KEY=your_jwt_secret_key
# API_KEY=your_api_key
```

### 5. 数据库迁移
```bash
# MongoDB 迁移
npm run migrate:mongodb

# 或 MySQL 迁移
npm run migrate
```

### 6. 开发模式启动
```bash
npm run dev
# 或
yarn dev
```

## 使用 Docker Compose 快速部署

### 1. 安装 Docker 和 Docker Compose
- 参考官方文档安装：[Docker](https://docs.docker.com/get-docker/)、[Docker Compose](https://docs.docker.com/compose/install/)

### 2. 克隆代码
```bash
git clone [仓库地址]
cd CloudVoiceNovel
```

### 3. 配置 docker-compose.yml
确保 docker-compose.yml 文件包含以下服务配置：
```yaml
version: '3'
services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    environment:
      - API_BASE_URL=http://backend:3000/api

  backend:
    build: ./backend
    ports:
      - "3000:3000"
    depends_on:
      - mongo
      - redis
    environment:
      - PORT=3000
      - DATABASE_URL=mongodb://mongo:27017/cloudvoicenovel
      - REDIS_URL=redis://redis:6379
      - SECRET_KEY=your_jwt_secret_key

  mongo:
    image: mongo:4.4
    volumes:
      - mongo-data:/data/db
    ports:
      - "27017:27017"

  redis:
    image: redis:6.0
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"

volumes:
  mongo-data:
  redis-data:
```

### 4. 启动服务
```bash
docker-compose up -d
```

## 验证部署

### 前端验证
- 访问 http://localhost:3000（如果直接启动前端开发服务器）
- 或 http://localhost（如果使用 Docker Compose）

### 后端验证
- API 健康检查：http://localhost:3000/api/health
- Swagger 文档：http://localhost:3000/api/docs

## 开发环境注意事项

1. **热更新**
   - 开发模式下，前后端都支持热更新，修改代码后自动重启

2. **日志查看**
   - 前端日志：在前端开发服务器控制台查看
   - 后端日志：在后端开发服务器控制台查看

3. **调试模式**
   - 后端默认启用调试模式，可通过环境变量 `NODE_ENV=development` 设置

4. **安全提示**
   - 开发环境不建议使用生产环境的 API 密钥和配置
   - 确保数据库密码使用复杂字符串

## 常见问题排查

1. **端口被占用**
   - 检查端口占用情况：`lsof -i :3000`
   - 修改配置文件中的端口号

2. **数据库连接失败**
   - 确认数据库服务是否启动
   - 检查连接字符串是否正确
   - 验证数据库用户权限

3. **依赖安装失败**
   - 清理 npm 缓存：`npm cache clean --force`
   - 检查网络连接
   - 尝试使用 `yarn` 替代 `npm`